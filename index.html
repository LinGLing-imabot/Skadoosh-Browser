<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Skadoosh's Browser</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üåê</text></svg>" />
  <script src="https://cdn.jsdelivr.net/npm/@titaniumnetwork-dev/ultraviolet@3.2.7/dist/uv.bundle.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@titaniumnetwork-dev/ultraviolet@3.2.7/dist/uv.config.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: #000;
      color: #fff;
      overflow: hidden;
      width: 100vw;
      height: 100vh;
    }
    .particles {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1;
    }
    .particle {
      position: absolute;
      width: 10px;
      height: 10px;
      background: #fff;
      border-radius: 50%;
      opacity: 0.8;
      animation: twinkle 3s ease-in-out infinite;
    }
    @keyframes twinkle {
      0%, 100% { opacity: 0.3; }
      50% { opacity: 1; }
    }
    #home {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 2;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: linear-gradient(180deg, rgba(0,0,0,0.95) 0%, rgba(26,26,26,0.95) 100%);
    }
    #home.hidden { display: none; }
    .home-header {
      position: fixed;
      top: 1.5rem;
      right: 1.5rem;
      display: flex;
      gap: 1rem;
      z-index: 10;
    }
    .icon-btn {
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.3);
      color: #fff;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
    }
    .icon-btn:hover {
      background: rgba(255,255,255,0.2);
      transform: scale(1.1);
    }
    h1 {
      font-size: 2.8rem;
      margin-bottom: 1.5rem;
      background: linear-gradient(45deg, #fff, #888);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-align: center;
    }
    .search {
      width: 600px;
      max-width: 90%;
      display: flex;
      gap: 0.8rem;
    }
    input {
      flex: 1;
      padding: 0.9rem 1.4rem;
      border: 2px solid #444;
      border-radius: 50px;
      background: rgba(26,26,26,0.8);
      color: #fff;
      font-size: 1rem;
      outline: none;
      transition: border 0.3s;
    }
    input:focus { border-color: #666; }
    input::placeholder { color: #888; }
    button {
      padding: 0.9rem 2rem;
      border: none;
      border-radius: 50px;
      background: #fff;
      color: #000;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 0.95rem;
    }
    button:hover { 
      background: #ddd;
      transform: translateY(-2px);
    }
    #browser {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 2;
      display: none;
      flex-direction: column;
      background: #000;
    }
    #browser.active { display: flex; }
    .toolbar {
      display: flex;
      background: #0a0a0a;
      border-bottom: 1px solid #222;
      padding: 0.6rem;
      gap: 0.5rem;
      align-items: center;
      flex-shrink: 0;
    }
    .toolbar button {
      padding: 0.6rem 1rem;
      border-radius: 8px;
      background: #1a1a1a;
      color: #fff;
      font-size: 0.95rem;
      border: 1px solid #333;
    }
    .toolbar button:hover { 
      background: #2a2a2a;
      transform: none;
    }
    .url-bar {
      flex: 1;
      padding: 0.6rem 1rem;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 8px;
      color: #fff;
      font-size: 0.95rem;
    }
    .tabs {
      display: flex;
      background: #0a0a0a;
      border-bottom: 1px solid #222;
      overflow-x: auto;
      flex-shrink: 0;
      scrollbar-width: thin;
      scrollbar-color: #333 #0a0a0a;
    }
    .tabs::-webkit-scrollbar { height: 6px; }
    .tabs::-webkit-scrollbar-track { background: #0a0a0a; }
    .tabs::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
    .tab {
      display: flex;
      align-items: center;
      gap: 0.8rem;
      padding: 0.8rem 1.2rem;
      background: #1a1a1a;
      border-right: 1px solid #222;
      cursor: pointer;
      white-space: nowrap;
      min-width: 180px;
      max-width: 220px;
      transition: background 0.2s;
      flex-shrink: 0;
    }
    .tab:hover { background: #252525; }
    .tab.active { background: #2a2a2a; border-bottom: 3px solid #fff; }
    .tab-title {
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      font-size: 0.9rem;
      color: #ccc;
    }
    .tab.active .tab-title { color: #fff; }
    .tab-close {
      color: #666;
      cursor: pointer;
      padding: 0.2rem 0.4rem;
      font-weight: bold;
      font-size: 1.1rem;
      transition: color 0.2s;
    }
    .tab-close:hover { color: #fff; }
    .new-tab {
      padding: 0.8rem 1.5rem;
      background: #1a1a1a;
      color: #888;
      cursor: pointer;
      font-size: 1.2rem;
      flex-shrink: 0;
      transition: all 0.2s;
    }
    .new-tab:hover { background: #252525; color: #fff; }
    .content {
      flex: 1;
      position: relative;
      background: #fff;
      overflow: hidden;
    }
    .tab-page {
      display: none;
      width: 100%;
      height: 100%;
      position: absolute;
      top: 0;
      left: 0;
    }
    .tab-page.active { display: flex; flex-direction: column; }
    iframe {
      width: 100%;
      height: 100%;
      border: none;
      flex: 1;
    }
    .new-tab-page {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      background: #f5f5f5;
    }
    .new-tab-page h2 {
      color: #333;
      margin-bottom: 2rem;
      font-size: 1.6rem;
    }
    .new-tab-search {
      width: 550px;
      max-width: 90%;
      display: flex;
      gap: 0.8rem;
    }
    .new-tab-search input {
      background: #fff;
      border: 2px solid #ddd;
      color: #333;
    }
    .new-tab-search input::placeholder { color: #999; }
    .new-tab-search button {
      background: #333;
      color: #fff;
    }
    .new-tab-search button:hover { background: #444; }
    .loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #666;
      font-size: 1.3rem;
      font-weight: 500;
      text-align: center;
    }
    .loading button {
      margin: 0.5rem;
      padding: 0.7rem 1.5rem;
      font-size: 0.9rem;
    }
    #settingsModal, #sourceModal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.85);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    #settingsModal.active, #sourceModal.active { display: flex; }
    .modal {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 12px;
      width: 550px;
      max-width: 90%;
      max-height: 85vh;
      overflow-y: auto;
      box-shadow: 0 10px 40px rgba(0,0,0,0.5);
    }
    .modal-header {
      padding: 1.3rem;
      border-bottom: 1px solid #333;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      background: #1a1a1a;
      z-index: 10;
    }
    .modal-header h2 {
      font-size: 1.4rem;
      color: #fff;
    }
    .close-btn {
      background: none;
      color: #888;
      font-size: 2rem;
      padding: 0;
      width: 35px;
      height: 35px;
      cursor: pointer;
      transition: color 0.2s;
    }
    .close-btn:hover { 
      color: #fff;
      transform: none;
    }
    .modal-body {
      padding: 1.5rem;
    }
    .setting-section {
      margin-bottom: 2rem;
    }
    .setting-section:last-child { margin-bottom: 0; }
    .setting-section h3 {
      margin-bottom: 1rem;
      font-size: 1.15rem;
      color: #fff;
      border-bottom: 1px solid #333;
      padding-bottom: 0.5rem;
    }
    .setting-item {
      margin-bottom: 1rem;
    }
    .setting-item label {
      display: block;
      margin-bottom: 0.5rem;
      color: #aaa;
      font-size: 0.9rem;
    }
    .setting-item input, .setting-item select {
      width: 100%;
      padding: 0.75rem;
      background: #0a0a0a;
      border: 1px solid #333;
      border-radius: 8px;
      color: #fff;
      font-size: 0.95rem;
    }
    .setting-item input:focus, .setting-item select:focus {
      border-color: #555;
      outline: none;
    }
    .setting-item button {
      width: 100%;
      margin-top: 0.5rem;
      border-radius: 8px;
      padding: 0.75rem;
    }
    .search-engine-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.8rem;
      margin-top: 0.8rem;
    }
    .search-engine-btn {
      padding: 1rem;
      background: #0a0a0a;
      border: 2px solid #333;
      border-radius: 8px;
      color: #fff;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 0.95rem;
    }
    .search-engine-btn:hover {
      background: #1a1a1a;
      border-color: #555;
      transform: translateY(-2px);
    }
    .search-engine-btn.active {
      background: #fff;
      color: #000;
      border-color: #fff;
    }
    .source-content {
      background: #0a0a0a;
      border: 1px solid #333;
      border-radius: 12px;
      width: 90%;
      max-width: 1200px;
      height: 90%;
      overflow: hidden;
      position: relative;
      display: flex;
      flex-direction: column;
    }
    .source-header {
      background: #0a0a0a;
      padding: 1.5rem 2rem;
      border-bottom: 2px solid #333;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 10;
      flex-shrink: 0;
    }
    .source-header h2 {
      color: #fff;
      font-size: 1.4rem;
      margin: 0;
    }
    .source-header-right {
      display: flex;
      gap: 1rem;
      align-items: center;
    }
    .source-body {
      flex: 1;
      overflow: auto;
      padding: 2rem;
    }
    .copy-btn {
      background: #fff;
      color: #000;
      border: none;
      padding: 0.8rem 1.5rem;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: bold;
      transition: all 0.3s;
    }
    .copy-btn:hover {
      background: #ddd;
      transform: translateY(-2px);
    }
    .copy-btn.copied {
      background: #0f0;
      color: #000;
    }
    .source-content pre {
      color: #0f0;
      font-family: 'Courier New', monospace;
      font-size: 0.9rem;
      white-space: pre-wrap;
      word-wrap: break-word;
      line-height: 1.5;
      margin: 0;
    }
    .alert-box {
      background: #1a1a1a;
      border: 2px solid #4CAF50;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1.5rem;
      color: #4CAF50;
    }
    .alert-box h4 {
      margin-bottom: 0.5rem;
      font-size: 1.1rem;
    }
    .alert-box p {
      font-size: 0.9rem;
      line-height: 1.6;
      margin: 0.3rem 0;
      color: #ddd;
    }
    .alert-box.warning {
      border-color: #ff9800;
      color: #ff9800;
    }
    .alert-box.success {
      border-color: #4CAF50;
      color: #4CAF50;
    }
    .alert-box.error {
      border-color: #f44336;
      color: #f44336;
    }
    .status-indicator {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 0.5rem;
    }
    .status-indicator.active { background: #4CAF50; }
    .status-indicator.inactive { background: #f44336; }
  </style>
</head>
<body>
  <div class="particles" id="particles"></div>

  <div id="home">
    <div class="home-header">
      <button class="icon-btn" onclick="openSettings()" title="Settings">‚öôÔ∏è</button>
      <button class="icon-btn" onclick="viewSource()" title="Source Code">&lt;/&gt;</button>
    </div>
    <h1>üåê Skadoosh's Browser</h1>
    <div class="search">
      <input id="homeSearch" placeholder="Search or enter URL" />
      <button onclick="goFromHome()">Go</button>
    </div>
  </div>

  <div id="browser">
    <div class="toolbar">
      <button onclick="goHome2()">üè†</button>
      <button onclick="goBack()">‚Üê</button>
      <button onclick="goForward()">‚Üí</button>
      <button onclick="reload()">‚Üª</button>
      <input class="url-bar" id="urlBar" placeholder="Search or enter URL" />
      <button onclick="goFromBar()">Go</button>
      <button onclick="openSettings()">‚öôÔ∏è</button>
      <button onclick="viewSource()">&lt;/&gt;</button>
    </div>
    <div class="tabs" id="tabsList"></div>
    <div class="content" id="content"></div>
  </div>

  <div id="settingsModal">
    <div class="modal">
      <div class="modal-header">
        <h2>Settings</h2>
        <button class="close-btn" onclick="closeSettings()">√ó</button>
      </div>
      <div class="modal-body">
        <div class="alert-box" id="swStatus">
          <h4><span class="status-indicator inactive"></span>Service Worker Status</h4>
          <p id="swStatusText">Checking...</p>
        </div>

        <div class="setting-section">
          <h3>Search Engine</h3>
          <div class="search-engine-grid">
            <button class="search-engine-btn active" onclick="setSearchEngine('google')">üîç Google</button>
            <button class="search-engine-btn" onclick="setSearchEngine('duckduckgo')">ü¶Ü DuckDuckGo</button>
            <button class="search-engine-btn" onclick="setSearchEngine('bing')">‚í∑ Bing</button>
            <button class="search-engine-btn" onclick="setSearchEngine('brave')">ü¶Å Brave</button>
            <button class="search-engine-btn" onclick="setSearchEngine('ecosia')">üå± Ecosia</button>
            <button class="search-engine-btn" onclick="setSearchEngine('startpage')">üîí StartPage</button>
          </div>
        </div>

        <div class="setting-section">
          <h3>Stealth Mode</h3>
          <div class="setting-item">
            <button onclick="enableStealth()">Open in STEALTH MODE</button>
          </div>
        </div>
          
        <div class="setting-section">
          <h3>Tab Cloak</h3>
          <div class="setting-item">
            <label>Tab Title</label>
            <input type="text" id="tabTitle" placeholder="Enter custom tab title" />
          </div>
          <div class="setting-item">
            <label>Favicon URL</label>
            <input type="text" id="faviconUrl" placeholder="Enter favicon URL" />
          </div>
          <div class="setting-item">
            <button onclick="resetTabCloak()">Reset to Default</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="sourceModal">
    <div class="source-content">
      <div class="source-header">
        <h2>Source Code</h2>
        <div class="source-header-right">
          <button class="copy-btn" id="copyBtn" onclick="copySourceCode()">üìã Copy All</button>
          <button class="close-btn" onclick="closeSource()">√ó</button>
        </div>
      </div>
      <div class="source-body">
        <pre id="sourceCode"></pre>
      </div>
    </div>
  </div>

  <script>
    (function() {
      window.onerror = function() { return true; };
      window.addEventListener('unhandledrejection', function(e) { e.preventDefault(); });
      
      for (let i = 0; i < 200; i++) {
        const p = document.createElement("div");
        p.className = "particle";
        p.style.left = Math.random() * 100 + "%";
        p.style.top = Math.random() * 100 + "%";
        p.style.animationDelay = Math.random() * 3 + "s";
        document.getElementById("particles").appendChild(p);
      }

      let tabs = [];
      let activeId = null;
      let counter = 0;
      let SEARCH_ENGINE = 'google';
      let swRegistration = null;
      let swReady = false;

      const SEARCH_ENGINES = {
        google: 'https://www.google.com/search?q=',
        duckduckgo: 'https://duckduckgo.com/?q=',
        bing: 'https://www.bing.com/search?q=',
        brave: 'https://search.brave.com/search?q=',
        ecosia: 'https://www.ecosia.org/search?q=',
        startpage: 'https://www.startpage.com/do/search?q='
      };

      async function registerSW() {
        if (!('serviceWorker' in navigator)) {
          updateSWStatus('Service workers not supported in this browser', false);
          return false;
        }

        // Check if already registered and controlling
        if (navigator.serviceWorker.controller) {
          swReady = true;
          updateSWStatus('Service Worker active and ready!', true);
          return true;
        }

        try {
          swRegistration = await navigator.serviceWorker.register('/uv.sw.js', {
            scope: '/'
          });

          // Wait for service worker to be ready
          await navigator.serviceWorker.ready;
          
          // If we have a controller, we're good
          if (navigator.serviceWorker.controller) {
            swReady = true;
            updateSWStatus('Service Worker active and ready!', true);
            return true;
          }
          
          // Wait for controller change
          return new Promise((resolve) => {
            navigator.serviceWorker.addEventListener('controllerchange', () => {
              swReady = true;
              updateSWStatus('Service Worker active and ready!', true);
              resolve(true);
            });
            
            // If no controller after 2 seconds, need reload
            setTimeout(() => {
              if (!navigator.serviceWorker.controller) {
                updateSWStatus('Reloading to activate service worker...', true);
                window.location.reload();
              }
            }, 2000);
          });
        } catch (error) {
          console.error('SW registration failed:', error);
          updateSWStatus('Failed to register service worker: ' + error.message, false);
          return false;
        }
      }

      function updateSWStatus(text, success) {
        const statusBox = document.getElementById('swStatus');
        const statusText = document.getElementById('swStatusText');
        const indicator = statusBox.querySelector('.status-indicator');
        
        statusText.textContent = text;
        
        if (success) {
          statusBox.className = 'alert-box success';
          statusBox.querySelector('h4').innerHTML = '<span class="status-indicator active"></span>Service Worker Active';
          indicator.className = 'status-indicator active';
        } else {
          statusBox.className = 'alert-box error';
          indicator.className = 'status-indicator inactive';
        }
      }

      // Initialize on load
      registerSW();

      window.setSearchEngine = function(engine) {
        SEARCH_ENGINE = engine;
        document.querySelectorAll('.search-engine-btn').forEach(btn => {
          btn.classList.remove('active');
        });
        event.target.classList.add('active');
      };

      function norm(url) {
        url = (url || '').trim();
        if (!url) return '';
        
        if (/^https?:\/\//i.test(url)) return url;
        
        if (/^[a-z0-9-]+\.[a-z]{2,}/i.test(url) && !url.includes(' ')) {
          return 'https://' + url;
        }
        
        return SEARCH_ENGINES[SEARCH_ENGINE] + encodeURIComponent(url);
      }

      function encodeUV(url) {
        if (window.__uv$config && typeof __uv$config.encodeUrl === 'function') {
          return '/service/' + __uv$config.encodeUrl(url);
        }
        return '/service/' + encodeURIComponent(url);
      }

      window.goFromHome = function() {
        const url = norm(document.getElementById('homeSearch').value);
        if (url) {
          if (!swReady) {
            alert('Service worker is still loading. Please wait a moment and try again.');
            return;
          }
          document.getElementById('home').classList.add('hidden');
          document.getElementById('browser').classList.add('active');
          createTab(url);
        }
      };

      window.goHome2 = function() {
        tabs.forEach(t => closeTab(t.id, true));
        tabs = [];
        activeId = null;
        document.getElementById('browser').classList.remove('active');
        document.getElementById('home').classList.remove('hidden');
        document.getElementById('homeSearch').value = '';
      };

      window.createTab = function(url) {
        const id = ++counter;
        const tab = { id: id, url: url || '', title: 'New Tab' };
        tabs.push(tab);

        const tabEl = document.createElement('div');
        tabEl.className = 'tab';
        tabEl.id = 't' + id;
        tabEl.innerHTML = '<span class="tab-title">New Tab</span><span class="tab-close">√ó</span>';
        tabEl.onclick = function(e) {
          if (e.target.className === 'tab-close') {
            closeTab(id);
          } else {
            switchTab(id);
          }
        };

        const newTabBtn = document.querySelector('.new-tab');
        if (newTabBtn) {
          document.getElementById('tabsList').insertBefore(tabEl, newTabBtn);
        } else {
          const btn = document.createElement('div');
          btn.className = 'new-tab';
          btn.textContent = '+';
          btn.onclick = function() { createTab(); };
          document.getElementById('tabsList').appendChild(tabEl);
          document.getElementById('tabsList').appendChild(btn);
        }

        const pageEl = document.createElement('div');
        pageEl.className = 'tab-page';
        pageEl.id = 'p' + id;
        
        if (url) {
          pageEl.innerHTML = '<div class="loading">Loading...</div><iframe id="f' + id + '" sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-modals allow-popups-to-escape-sandbox"></iframe>';
        } else {
          pageEl.innerHTML = '<div class="new-tab-page"><h2>New Tab</h2><div class="new-tab-search"><input id="nts' + id + '" placeholder="Search or enter URL" /><button onclick="loadFromNewTab(' + id + ')">Go</button></div></div>';
        }
        
        document.getElementById('content').appendChild(pageEl);
        switchTab(id);
        
        if (url) {
          loadUrl(id, url);
        } else {
          setTimeout(function() {
            const inp = document.getElementById('nts' + id);
            if (inp) {
              inp.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') loadFromNewTab(id);
              });
            }
          }, 100);
        }
      };

      window.loadFromNewTab = function(id) {
        const inp = document.getElementById('nts' + id);
        if (!inp) return;
        const url = norm(inp.value);
        if (!url) return;
        
        if (!swReady) {
          alert('Service worker is still loading. Please wait a moment and try again.');
          return;
        }
        
        const tab = tabs.find(t => t.id === id);
        if (tab) tab.url = url;
        
        const pageEl = document.getElementById('p' + id);
        if (pageEl) {
          pageEl.innerHTML = '<div class="loading">Loading...</div><iframe id="f' + id + '" sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-modals allow-popups-to-escape-sandbox"></iframe>';
          loadUrl(id, url);
        }
      };

      function loadUrl(id, url) {
        const frame = document.getElementById('f' + id);
        if (!frame) return;
        const tab = tabs.find(t => t.id === id);
        
        const proxiedUrl = encodeUV(url);
        frame.src = proxiedUrl;
        
        let loadTimeout = setTimeout(function() {
          const loading = document.querySelector('#p' + id + ' .loading');
          if (loading && loading.textContent === 'Loading...') {
            loading.innerHTML = '‚ö†Ô∏è Still loading...<br><small>Some sites may take longer</small>';
          }
        }, 8000);
        
        frame.onload = function() {
          clearTimeout(loadTimeout);
          if (tab) {
            tab.title = getHostname(url);
            updateTabTitle(id, tab.title);
          }
          const loading = document.querySelector('#p' + id + ' .loading');
          if (loading) loading.remove();
        };
        
        frame.onerror = function() {
          clearTimeout(loadTimeout);
          const loading = document.querySelector('#p' + id + ' .loading');
          if (loading) {
            loading.innerHTML = '‚ùå Unable to load<br><small>Try a different site or check your connection</small><br><br><button onclick="reload()">Retry</button>';
          }
        };
      }

      function getHostname(url) {
        try {
          return new URL(url).hostname;
        } catch(e) {
          return 'New Tab';
        }
      }

      function updateTabTitle(id, title) {
        const el = document.querySelector('#t' + id + ' .tab-title');
        if (el) el.textContent = title;
      }

      function switchTab(id) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-page').forEach(p => p.classList.remove('active'));
        
        const tab = document.getElementById('t' + id);
        const page = document.getElementById('p' + id);
        
        if (tab) tab.classList.add('active');
        if (page) page.classList.add('active');
        
        activeId = id;
        
        const t = tabs.find(x => x.id === id);
        if (t) document.getElementById('urlBar').value = t.url || '';
      }

      function closeTab(id, silent) {
        const idx = tabs.findIndex(t => t.id === id);
        if (idx > -1) tabs.splice(idx, 1);
        
        const tab = document.getElementById('t' + id);
        const page = document.getElementById('p' + id);
        
        if (tab) tab.remove();
        if (page) page.remove();
        
        if (!silent && activeId === id) {
          if (tabs.length > 0) {
            switchTab(tabs[tabs.length - 1].id);
          } else {
            goHome2();
          }
        }
      }

      window.goFromBar = function() {
        const url = norm(document.getElementById('urlBar').value);
        if (!url) return;
        
        if (!swReady) {
          alert('Service worker is still loading. Please wait a moment and try again.');
          return;
        }
        
        if (activeId) {
          const tab = tabs.find(t => t.id === activeId);
          if (tab) tab.url = url;
          
          const page = document.getElementById('p' + activeId);
          if (page) {
            page.innerHTML = '<div class="loading">Loading...</div><iframe id="f' + activeId + '" sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-modals allow-popups-to-escape-sandbox"></iframe>';
            loadUrl(activeId, url);
          }
        } else {
          createTab(url);
        }
      };

      window.goBack = function() {
        const frame = document.getElementById('f' + activeId);
        if (frame && frame.contentWindow) {
          try { frame.contentWindow.history.back(); } catch(e) {}
        }
      };

      window.goForward = function() {
        const frame = document.getElementById('f' + activeId);
        if (frame && frame.contentWindow) {
          try { frame.contentWindow.history.forward(); } catch(e) {}
        }
      };

      window.reload = function() {
        const tab = tabs.find(t => t.id === activeId);
        if (tab && tab.url) {
          loadUrl(activeId, tab.url);
        }
      };

      window.openSettings = function() {
        document.getElementById('settingsModal').classList.add('active');
      };

      window.closeSettings = function() {
        document.getElementById('settingsModal').classList.remove('active');
      };

      document.getElementById('tabTitle').addEventListener('input', function(e) {
        const title = e.target.value;
        document.title = title || "Skadoosh's Browser";
      });

      document.getElementById('faviconUrl').addEventListener('input', function(e) {
        const favicon = e.target.value;
        let link = document.querySelector("link[rel*='icon']");
        if (!link) {
          link = document.createElement('link');
          link.rel = 'icon';
          document.head.appendChild(link);
        }
        link.href = favicon || "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üåê</text></svg>";
      });

      window.resetTabCloak = function() {
        document.title = "Skadoosh's Browser";
        let link = document.querySelector("link[rel*='icon']");
        if (link) {
          link.href = "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üåê</text></svg>";
        }
        document.getElementById('tabTitle').value = '';
        document.getElementById('faviconUrl').value = '';
      };

      window.enableStealth = function() {
        const win = window.open('about:blank');
        if (win) {
          win.document.write(document.documentElement.outerHTML);
          win.document.close();
          alert('Stealth mode activated! You can close this tab now.');
        }
      };

      window.viewSource = function() {
        document.getElementById('sourceCode').textContent = document.documentElement.outerHTML;
        document.getElementById('sourceModal').classList.add('active');
        const copyBtn = document.getElementById('copyBtn');
        copyBtn.textContent = 'üìã Copy All';
        copyBtn.classList.remove('copied');
      };

      window.copySourceCode = function() {
        const sourceCode = document.getElementById('sourceCode').textContent;
        navigator.clipboard.writeText(sourceCode).then(function() {
          const copyBtn = document.getElementById('copyBtn');
          copyBtn.textContent = '‚úì Copied!';
          copyBtn.classList.add('copied');
          setTimeout(function() {
            copyBtn.textContent = 'üìã Copy All';
            copyBtn.classList.remove('copied');
          }, 2000);
        }).catch(function(err) {
          alert('Failed to copy: ' + err);
        });
      };

      window.closeSource = function() {
        document.getElementById('sourceModal').classList.remove('active');
      };

      document.getElementById('homeSearch').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') goFromHome();
      });

      document.getElementById('urlBar').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') goFromBar();
      });
    })();
  </script>
</body>
</html> 